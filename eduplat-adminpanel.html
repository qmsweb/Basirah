<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - رفع الملفات</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #f1f5f9;
            --surface-color: #ffffff;
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --error-color: #ef4444;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            margin: 0;
            padding: 0;
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* --- الهيدر --- */
        .admin-header {
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0 2rem;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .brand-text h1 {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary-color);
            margin: 0;
        }

        .back-link {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9em;
            transition: 0.2s;
        }
        .back-link:hover { color: var(--primary-color); }

        /* --- الحاوية --- */
        .container {
            max-width: 600px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .upload-card {
            background: var(--surface-color);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .card-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .card-header h2 { margin: 0; font-size: 1.5rem; }
        .card-header p { color: var(--text-secondary); margin-top: 5px; font-size: 0.9rem; }

        /* --- عناصر النموذج --- */
        .form-group { margin-bottom: 20px; }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            box-sizing: border-box;
            transition: 0.2s;
        }

        .form-input:focus {
            border-color: var(--primary-color);
            outline: none;
            background-color: #f8fafc;
        }

        .form-input[readonly] {
            background-color: #f1f5f9;
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        /* --- منطقة رفع الملف --- */
        .file-upload-wrapper {
            position: relative;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: 0.2s;
            cursor: pointer;
        }

        .file-upload-wrapper:hover {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }

        .file-upload-input {
            position: absolute;
            left: 0; top: 0; width: 100%; height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        /* --- الأزرار --- */
        .btn-submit {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-submit:hover { background-color: var(--primary-hover); }
        .btn-submit:disabled { background-color: var(--text-secondary); cursor: not-allowed; }

        /* --- رسائل التنبيه --- */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-size: 0.9rem;
        }
        .alert-success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* تلميح صغير */
        .hint { font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px; }

    </style>
</head>
<body>

    <header class="admin-header">
        <div class="brand-text">
            <h1><i class="fas fa-cogs"></i> لوحة التحكم</h1>
        </div>
        <a href="index.html" class="back-link"><i class="fas fa-arrow-right"></i> العودة للأرشيف</a>
    </header>

    <div class="container">
        <div class="upload-card">
            <div class="card-header">
                <h2>رفع ملف جديد</h2>
                <p>سيتم إضافة الملف للأرشيف الشجري تلقائياً</p>
            </div>

            <form id="uploadForm">
                
                <div class="form-group">
                    <label class="form-label">اختر الملف</label>
                    <div class="file-upload-wrapper" id="dropZone">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <div id="fileLabel">اضغط هنا لاختيار ملف</div>
                        <input type="file" id="fileInput" class="file-upload-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">مسار الملف (لإنشاء المجلدات)</label>
                    <input type="text" id="fileNameInput" class="form-input" placeholder="مثال: الإدارة/التقارير/تقرير-2024.pdf" required>
                    <div class="hint">استخدم العلامة (/) لإنشاء مجلدات فرعية.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">رابط الملف (يتم جلبه تلقائياً)</label>
                    <div style="position: relative;">
                        <input type="text" id="fileUrlInput" class="form-input" placeholder="سيظهر الرابط هنا بعد الرفع..." readonly>
                        <i class="fas fa-link" style="position: absolute; left: 15px; top: 15px; color: var(--text-secondary);"></i>
                    </div>
                </div>

                <button type="submit" id="submitBtn" class="btn-submit">
                    <span>رفع وحفظ البيانات</span>
                    <i class="fas fa-save"></i>
                </button>

                <div id="statusMessage" class="alert"></div>

            </form>
        </div>
    </div>

    <script>
        // إعداد Supabase (نفس المفاتيح الخاصة بك)
        const SUPABASE_URL = 'https://bajprxgogzpnftphuxka.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhanByeGdvZ3pwbmZ0cGh1eGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzOTY5NDYsImV4cCI6MjA4Mzk3Mjk0Nn0.i2lYRllL-D79pSeWCT8WTbpnAE9DBhqUW8_2JrBedIU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // العناصر
        const fileInput = document.getElementById('fileInput');
        const fileNameInput = document.getElementById('fileNameInput');
        const fileUrlInput = document.getElementById('fileUrlInput');
        const submitBtn = document.getElementById('submitBtn');
        const statusMsg = document.getElementById('statusMessage');
        const fileLabel = document.getElementById('fileLabel');
        const dropZone = document.getElementById('dropZone');

        // تحديث اسم الملف عند الاختيار
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileLabel.textContent = file.name;
                dropZone.style.borderColor = 'var(--primary-color)';
                dropZone.style.backgroundColor = '#eff6ff';
                
                // اقتراح اسم تلقائي إذا كان الحقل فارغاً
                if (!fileNameInput.value) {
                    fileNameInput.value = file.name;
                }
            }
        });

        // دالة الرفع والحفظ
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = fileInput.files[0];
            const pathName = fileNameInput.value.trim(); // الاسم الذي سيظهر في الشجرة

            if (!file) {
                showAlert('الرجاء اختيار ملف', 'error');
                return;
            }
            if (!pathName) {
                showAlert('الرجاء كتابة اسم الملف أو المسار', 'error');
                return;
            }

            setLoading(true);

            try {
                // 1. رفع الملف إلى Supabase Storage (Bucket: uploads)
                // نستخدم Timestamp لتجنب تكرار الأسماء في التخزين
                const storagePath = `public/${Date.now()}_${file.name.replace(/\s+/g, '-')}`;
                
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('uploads')
                    .upload(storagePath, file);

                if (uploadError) throw uploadError;

                // 2. جلب الرابط العام (Public URL)
                const { data: urlData } = supabase.storage
                    .from('uploads')
                    .getPublicUrl(storagePath);

                const publicUrl = urlData.publicUrl;

                // عرض الرابط في الخانة (حسب طلبك)
                fileUrlInput.value = publicUrl;

                // 3. حفظ البيانات في جدول قاعدة البيانات (files)
                // هذا الجدول هو الذي تقرأ منه صفحة الشجرة
                const { error: dbError } = await supabase
                    .from('files')
                    .insert([
                        { 
                            name: pathName,    // الاسم مع المسار (مثل: مجلد/ملف.pdf)
                            file_url: publicUrl // الرابط الذي تم جلبه
                        }
                    ]);

                if (dbError) throw dbError;

                showAlert('تم رفع الملف وحفظه بنجاح!', 'success');
                
                // إعادة تعيين النموذج بعد ثانيتين
                setTimeout(() => {
                    document.getElementById('uploadForm').reset();
                    fileLabel.textContent = 'اضغط هنا لاختيار ملف';
                    fileUrlInput.value = '';
                    setLoading(false);
                    dropZone.style = '';
                }, 2000);

            } catch (error) {
                console.error(error);
                showAlert('حدث خطأ: ' + error.message, 'error');
                setLoading(false);
            }
        });

        // دوال مساعدة
        function showAlert(msg, type) {
            statusMsg.style.display = 'block';
            statusMsg.textContent = msg;
            if (type === 'success') {
                statusMsg.className = 'alert alert-success';
            } else {
                statusMsg.className = 'alert alert-error';
            }
        }

        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الرفع...';
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>رفع وحفظ البيانات</span><i class="fas fa-save"></i>';
            }
        }
    </script>
</body>
</html>
