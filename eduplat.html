<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مكتبة الملفات</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary-color: #4a90e2;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 40px 20px;
            color: var(--text-primary);
        }

        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h2 { font-size: 28px; color: #333; margin-bottom: 10px; }
        .file-list { list-style: none; padding: 0; display: grid; gap: 15px; }
        .file-item-link { text-decoration: none; color: inherit; display: block; }

        .file-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .file-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .icon-box { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-left: 20px; flex-shrink: 0; }
        .file-info { flex-grow: 1; }
        .file-name { font-weight: 700; font-size: 16px; margin-bottom: 5px; display: block; }
        .file-meta { font-size: 13px; color: var(--text-secondary); display: flex; gap: 15px; }
        .action-icon { color: var(--text-secondary); opacity: 0.5; transition: 0.3s; }
        .file-card:hover .action-icon { opacity: 1; color: var(--primary-color); }

        /* ألوان */
        .type-pdf { background-color: #fadbd8; color: #e74c3c; }
        .type-doc { background-color: #d6eaf8; color: #2980b9; }
        .type-xls { background-color: #d5f5e3; color: #27ae60; }
        .type-img { background-color: #ebdef0; color: #8e44ad; }
        .type-zip { background-color: #fdebd0; color: #d35400; }
        .type-default { background-color: #eceff1; color: #607d8b; }

        /* رسائل الحالة */
        .status-msg { text-align: center; padding: 40px; color: var(--text-secondary); }
        .error-msg { 
            background-color: #fee2e2; 
            color: #b91c1c; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid #fca5a5;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2><i class="fas fa-folder-open" style="color: #4a90e2;"></i> الملفات المتاحة</h2>
            <p id="statusText">جاري الاتصال بقاعدة البيانات...</p>
        </div>

        <ul class="file-list" id="fileListContainer">
            <li class="status-msg">
                <i class="fas fa-circle-notch fa-spin fa-2x"></i>
                <br><br>جاري التحميل...
            </li>
        </ul>
    </div>

    <script>
        // دالة لعرض الخطأ بوضوح للمستخدم
        function showError(message, detail) {
            const listContainer = document.getElementById('fileListContainer');
            const statusText = document.getElementById('statusText');
            
            statusText.innerText = "حدث خطأ";
            statusText.style.color = "red";

            listContainer.innerHTML = `
                <li class="error-msg">
                    <strong><i class="fas fa-bug"></i> خطأ تقني:</strong><br>
                    ${message}<br><br>
                    <small style="direction:ltr; display:block; text-align:left;">${detail}</small>
                </li>
            `;
        }

        // 1. التأكد من تحميل المكتبة
        if (typeof window.supabase === 'undefined') {
            showError("لم يتم تحميل مكتبة Supabase", "Check your internet connection or CDN link.");
        } else {

            // 2. إعداد الاتصال
            const SUPABASE_URL = 'https://bajprxgogzpnftphuxka.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhanByeGdvZ3pwbmZ0cGh1eGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzOTY5NDYsImV4cCI6MjA4Mzk3Mjk0Nn0.i2lYRllL-D79pSeWCT8WTbpnAE9DBhqUW8_2JrBedIU';

            try {
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                function getFileStyle(filename) {
                    if (!filename) return { icon: 'fa-file', class: 'type-default', label: 'ملف' };
                    const ext = filename.split('.').pop().toLowerCase();
                    if (['pdf'].includes(ext)) return { icon: 'fa-file-pdf', class: 'type-pdf', label: 'ملف PDF' };
                    if (['doc', 'docx'].includes(ext)) return { icon: 'fa-file-word', class: 'type-doc', label: 'Word' };
                    if (['xls', 'xlsx'].includes(ext)) return { icon: 'fa-file-excel', class: 'type-xls', label: 'Excel' };
                    if (['jpg', 'png', 'jpeg'].includes(ext)) return { icon: 'fa-file-image', class: 'type-img', label: 'صورة' };
                    if (['zip', 'rar'].includes(ext)) return { icon: 'fa-file-zipper', class: 'type-zip', label: 'مضغوط' };
                    return { icon: 'fa-file', class: 'type-default', label: ext.toUpperCase() };
                }

                async function loadFiles() {
                    const listContainer = document.getElementById('fileListContainer');
                    const statusText = document.getElementById('statusText');

                    try {
                        console.log("Start fetching..."); // للتجربة في الكونسول

                        // جلب البيانات
                        let { data: files, error } = await supabase
                            .from('files')
                            .select('*')
                            .order('created_at', { ascending: false });

                        if (error) throw error;

                        console.log("Data fetched:", files); // للتجربة في الكونسول

                        listContainer.innerHTML = ''; 
                        statusText.innerText = "تصفح وحمل الملفات من القائمة أدناه";

                        if (!files || files.length === 0) {
                            listContainer.innerHTML = '<li class="status-msg">الجدول فارغ، لا توجد ملفات.</li>';
                            return;
                        }

                        files.forEach(file => {
                            const style = getFileStyle(file.name);
                            // حماية ضد التواريخ الفارغة
                            const date = file.created_at ? new Date(file.created_at).toLocaleDateString('ar-EG') : 'بدون تاريخ';
                            const url = file.file_url || '#';

                            const htmlItem = `
                                <li>
                                    <a href="${url}" target="_blank" class="file-item-link">
                                        <div class="file-card">
                                            <div class="icon-box ${style.class}">
                                                <i class="fas ${style.icon}"></i>
                                            </div>
                                            <div class="file-info">
                                                <span class="file-name">${file.name || 'بدون اسم'}</span>
                                                <div class="file-meta">
                                                    <span><i class="far fa-file"></i> ${style.label}</span>
                                                    <span><i class="far fa-calendar-alt"></i> ${date}</span>
                                                </div>
                                            </div>
                                            <div class="action-icon">
                                                <i class="fas fa-download"></i>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                            `;
                            listContainer.innerHTML += htmlItem;
                        });

                    } catch (err) {
                        console.error("Error caught:", err);
                        showError("فشل في جلب البيانات من السيرفر", err.message || JSON.stringify(err));
                    }
                }

                // تشغيل الدالة
                loadFiles();

            } catch (setupError) {
                showError("خطأ في إعداد Supabase", setupError.message);
            }
        }
    </script>
</body>
</html>
